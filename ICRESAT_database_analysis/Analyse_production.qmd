---
title: "Partie 3 : Analyse de la production de la base Cultivation 2014"
format: html
editor: source
---

```{r, message=FALSE, warning=FALSE}
rm(list = ls())
graphics.off()
cat("\014")
```

```{r, message=FALSE, warning=FALSE}
here::i_am("ICRESAT_database_analysis/Analyse_production.qmd")
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(knitr)
library(viridisLite)
library(stringr)
library(tibble)
library(tidyverse)
library(gt)
```

```{r}
Cultivation_expand <- readRDS(here::here("Base de données générées", "Cultivation_expand", "Cultivation_expand.rds"))
```

Analyse de la base Cultivation_expand, pour l'année 2014

Cette base inclut les opérations non complétées (c’est-à-dire celles avec un temps de travail égal à 0), pour lesquelles on a ajouté des lignes, et les variables Caste et Caste_group. 


********************************************************************************


## Principales cultures

```{r Nombre de ménages, champs et cultures distincts}
n_menages <- Cultivation_expand |>
  distinct(VDS_ID) |>
  summarise(nb = n()) |>
  pull(nb)

n_champs <- Cultivation_expand |>
  distinct(VDS_ID, PLOT_CODE, SEASON) |>
  summarise(nb = n()) |>
  pull(nb)

n_crops <- Cultivation_expand |>
  distinct(CROP) |>
  summarise(nb = n()) |>
  pull(nb)

cat("Nombre total de ménages :", n_menages, "\n")
cat("Nombre total de champs distincts :", n_champs, "\n")
cat("Nombre total de cultures :", n_crops, "\n")
```

```{r Champs par saison}
Cultivation_expand |>
  group_by(SEASON) |>
  summarise(
    `Nombre de ménages` = n_distinct(VDS_ID),
    `Nombre de champs` = n_distinct(paste(VDS_ID, PLOT_CODE, SEASON, CROP, sep = "_"))
  ) |>
  gt() |>
  tab_header(
    title = "Ménages et champs par saison"
  ) |>
  cols_label(
    SEASON = "Saison"
  )
```


```{r Principales cultures}
plot_cultures <- Cultivation_expand |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  distinct(VDS_ID, PLOT_CODE, SEASON, CROP) |>
  count(CROP, name = "nb") |>
  arrange(desc(nb)) |>
  slice_max(nb, n = 10) |>
  ggplot(aes(x = reorder(CROP, nb), y = nb)) +
  geom_bar(stat = "identity", fill = "steelblue2", color = "royalblue4", width = 0.8) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "",
    y = "Number of plots",
    title = "   10 most commonly grown crops per season"
  ) +
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12, color = "grey20")
  )

plot_cultures
```

```{r}
# Enregistrement automatique dans un fichier PNG
ggsave("figures/Top10_cultures.png", 
       plot = plot_cultures, 
       width = 8, height = 6, dpi = 300,
       create.dir = TRUE)
```

Je regarde comment les ménages / plots sont réparties selon les régions. 

```{r}
n_menages_region <- Cultivation_expand |>
  distinct(VDS_ID, REGION) |>
  count(REGION, name = "nb_menages")

n_plots_region <- Cultivation_expand |>
  distinct(VDS_ID, PLOT_CODE, SEASON, REGION) |>
  count(REGION, name = "nb_plots")

full_join(n_menages_region, n_plots_region, by = "REGION")
```


********************************************************************************

## Cultures par village

```{r}
Cultivation_expand <- Cultivation_expand |>
  filter(AREA_CROP != 0) |>
  filter(!MULTI_CROPING) |>
  filter(is.na(HUMAN_LABOR) | HUMAN_LABOR == TRUE) |>
  distinct()

# Je garde les NA de HUMAN_LABOR pour conserver les opérations non complétées (WORK_HR = 0) et les prendre en compte dans le calcul de h/acre moyen. 
```

J'applique différents filtres sur Cultivation_expand avant le calcul du ratio Hr/acre par champ. 

Filtres appliqués : 
- Enlever les champs pour lesquels AREA_CROP = 0, ce qui fausse le calcul de HR_PER_ACRE
- Enlever les champs en multi-cropping, qui ont souvent des très petites superficies, donc ce qui amène à un Hr/acre trop grand
- Conserver seulement le travail humain
- Enlever les lignes en doublons

Dans le cas de multi-cropping (plusieurs cultures sur un même champ pendant une même saison), on a estimé que la productivité du travail (heures de travail par acre) est égale entre chaque cultures.

```{r}
# Sélectionner avec la base Cultivation_top_25 les 25 cultures les plus répandues (celles avec le plus grand nombre de champs distincts)
top_25_crops <- Cultivation_expand |>
  filter(CROP != "SEASONAL FALLOW") |>
  distinct(VDS_ID, PLOT_CODE, SEASON, CROP, AREA_CROP) |> 
  count(CROP, name = "nb_occurrences") |>
  arrange(desc(nb_occurrences)) |>
  slice_head(n = 25)

Cultivation_top_25 <- Cultivation_expand |>
  semi_join(top_25_crops, by = "CROP") 
```


### Nombre de cultures différentes par village 

On regarde la variété de cultures faites par village. Pour cela, je compte le nombre de cultures différentes dans chaque village. 

```{r}
crops_village <- Cultivation_expand |>
  filter(CROP != "SEASONAL FALLOW") |>
  distinct(STATE, VILLAGE, CROP) |>
  count(STATE, VILLAGE, name = "diff_crops")

# Histogramme du nombre de cultures différentes par village 
plot_crops_village <- crops_village |>
  ggplot(aes(x = diff_crops)) +
  geom_histogram(fill = "steelblue2", color = "royalblue4", binwidth = 1, alpha = 0.6) +
  theme_minimal() +
  labs(
    x = "Number of different crops",
    y = "Number of villages",
    title = "Diversity of crops cultivated by village"
  ) +
  scale_x_continuous(breaks = 0:15) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12, color = "grey20"),
    axis.title.y = element_text(size = 12, color = "grey20")
  )

plot_crops_village
```

```{r}
ggsave("figures/Crops_per_village.png", plot = plot_crops_village, width = 8, height = 6, dpi = 300)
```


### Culture dominante par village

Je regarde quelles sont les 2 cultures les plus répandues dans chaque village.

```{r}
main_crop_village <- Cultivation_expand |>
  filter(CROP != "SEASONAL FALLOW") |>
  distinct(VDS_ID, PLOT_CODE, SEASON, VILLAGE, CROP) |>
  count(VILLAGE, CROP, name = "n") |>
  group_by(VILLAGE) |>
  arrange(desc(n)) |>
  mutate(rank = row_number()) |>
  ungroup()
```

```{r}
top1_cultures <- main_crop_village |>
  filter(rank == 1) |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  count(CROP, name = "nb_villages") |>
  mutate(Position = "1st crop")

top2_cultures <- main_crop_village |>
  filter(rank == 2) |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  count(CROP, name = "nb_villages") |>
  mutate(Position = "2nd crop")
```

```{r}
top_crops_villages <- bind_rows(top1_cultures, top2_cultures) |>
  group_by(Position) |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  slice_max(nb_villages, n = 10, with_ties = FALSE) |>
  ungroup()

plot_top_crop <- ggplot(top_crops_villages, aes(x = reorder(CROP, nb_villages), y = nb_villages)) +
  geom_col(fill = "steelblue2", color = "royalblue4", alpha = 0.6) +
  coord_flip() +
  facet_wrap(~ Position, scales = "free_y") +
  labs(
    x = "",
    y = "Number of villages",
    title = " Most common crops cultivated by village"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12, color = "grey20")
  )

plot_top_crop
```

```{r}
ggsave("figures/Top_crop_village.png", plot = plot_top_crop, width = 8, height = 6, dpi = 300)
```


On regarde maintenant la proportion de ménages dans chaque village qui cultivent les 2 cultures dominantes (associées à son village). 

Pour cela, j'ajoute la variable rank à une table qui comptabilise les ménages distincts par village et leur culture associé. Ensuite je calcule la proportion de ménages qui ont la cuture rank 1.

```{r First main crop}
# Étape 1: Identifier la crop de rang 1 pour chaque village
main_crop_rank1 <- main_crop_village |>
  filter(rank == 1) |>
  select(VILLAGE, CROP) |>
  rename(CROP_RANK1 = CROP)

# Étape 2: Indiquer si un ménage cultive la crop de rang 1
hh_crops_1 <- Cultivation_expand |>
  distinct(VDS_ID, VILLAGE, CROP) |>
  left_join(main_crop_rank1, by = "VILLAGE") |>
  mutate(cultive_crop1 = if_else(CROP == CROP_RANK1, 1, 0))

# Étape 3: Calculer la proportion
prop_top1_crop <- hh_crops_1 |>
  group_by(VILLAGE, CROP_RANK1) |>
  summarise(
    total_menages = n_distinct(VDS_ID),
    menages_cultivant_crop1 = n_distinct(VDS_ID[cultive_crop1 == 1]),
    prop_crop = menages_cultivant_crop1 / total_menages,
    .groups = "drop"
  ) |>
  rename(CROP = CROP_RANK1)
```

```{r Second main crop}
# Étape 1: Identifier la crop de rang 2 pour chaque village
main_crop_rank2 <- main_crop_village |>
  filter(rank == 2) |>
  select(VILLAGE, CROP) |>
  rename(CROP_RANK2 = CROP)

# Étape 2: Indiquer si un ménage cultive la crop de rang 2
hh_crops_2 <- Cultivation_expand |>
  distinct(VDS_ID, VILLAGE, CROP) |>
  left_join(main_crop_rank2, by = "VILLAGE") |>
  mutate(cultive_crop2 = if_else(CROP == CROP_RANK2, 2, 0))

# Étape 3: Calculer la proportion
prop_top2_crop <- hh_crops_2 |>
  group_by(VILLAGE, CROP_RANK2) |>
  summarise(
    total_menages = n_distinct(VDS_ID),
    menages_cultivant_crop2 = n_distinct(VDS_ID[cultive_crop2 == 2]),
    prop_crop = menages_cultivant_crop2 / total_menages,
    .groups = "drop"
  ) |>
  rename(CROP = CROP_RANK2)
```

```{r}
prop_top1_crop <- prop_top1_crop |>
  mutate(RANK = "1st crop")

prop_top2_crop <- prop_top2_crop |>
  mutate(RANK = "2nd crop")

prop_crop_combined <- bind_rows(prop_top1_crop, prop_top2_crop)
```

On regarde la variation de la part de ménages cultivant la culture dominante (de leur village), toutes cultures confondues. 

```{r}
boxplot_combined_prop <- ggplot(prop_crop_combined, aes(x = reorder(RANK, prop_crop), y = prop_crop)) +
  geom_boxplot(fill = "steelblue2", color = "royalblue4", alpha = 0.6) +
  coord_flip() +
  labs(
    title = "Share of households growing their village's main crops",
    x = "",
    y = "Share of households by village"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12, color = "grey20")
  )

boxplot_combined_prop
```

```{r}
ggsave("figures/Boxplot_combined_share.png", plot = boxplot_combined_prop, width = 8, height = 6, dpi = 300)
```


Le graphique suivant montre la même variation de la part de ménages cultivant la culture dominante, en distinguant par culture. 

```{r}
boxplot_combined_crops <- ggplot(prop_crop_combined, aes(x = reorder(CROP, prop_crop), y = prop_crop)) +
  geom_boxplot(fill = "steelblue2", color = "royalblue4", alpha = 0.6) +
  coord_flip() +
  facet_wrap(~ RANK, scales = "free_y") +
  labs(
    title = "Share of households growing their village's main crops",
    x = "Main crops by village",
    y = "Share of households by village"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text = element_text(size = 11),
    strip.text = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12, color = "grey20")
  )

boxplot_combined_crops
```


********************************************************************************

## Superficie des champs

On regarde la distribution de la superficie des champs, sachant que la base ICRISAT tend à surreprésenter les grandes fermes. 

```{r, message=FALSE, warning=FALSE}
Cultivation_expand |>
  distinct(VDS_ID, PLOT_CODE, CROP, SEASON, AREA_CROP) |>
  ggplot(aes(x = AREA_CROP)) +
  geom_histogram(binwidth = 0.2, fill = "hotpink3", color = "white", alpha = 0.8) +
  labs(
    title = "Distribution de la superficie des champs",
    x = "Superficie (en acres)",
    y = ""
  ) +
  xlim(0, 8) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12)
  )  
```


********************************************************************************

## Moyenne total- Heures par acre

Les heures de travail par acre (Hr/acre) est notre variable principale pour estimer le temps de travail dédié à chaque culture par saison. Cette mesure permet de neutraliser les différences de taille entre les champs et le nombre variable d'opérations effectuées par champ.

Le but est de mesurer la moyenne des ratios Hr/acre pour l'ensemble des champs. Pour cela, je calcule le ratio Hr/acre pour chaque champ, puis je divise la somme de ces ratios par le nombre de champs distincts. 

Calculer ce ratio à l'échelle du champ permet de comparer les résultats selon plusieurs variables propres à chaque champ : la culture, l'irrigation, la variété de graine utilisée. 

Par exemple, pour obtenir la moyenne de Hr/acre d’une culture spécifique, on additionne tous les ratios des champs cultivant cette culture, puis on divise ce total par le nombre de champs concernés.


### Ratio: Heures par acre au niveau du champ

Pour calculer le ratio Hr/acre, j’additionne les heures de travail de toutes les opérations effectuées sur un même champ, puis je divise ce total par la superficie du champ (AREA_CROP).

La combinaison des variables suivantes permet d’identifier de façon unique un champ :
- VDS_ID (identifiant du ménage)
- PLOT_CODE (identifiant du champ)
- SEASON (analyse du temps de travail par saison)
- CROP (notamment en cas de multi-cropping)
_ AREA_CROP (utilisée cmme clé d'identification des champs dans la base précédente)

Je crée une table pour n'avoir qu'une seule ligne par champ (avec distinct) avant de calculer le ratio Hr/acre par champ (variable HR_PER_ACRE). 

```{r}
# Créer une base pour calculer le ratio Hr/acre par champ (variable HR_PER_ACRE)
hr_per_acre <- Cultivation_top_25 |>
  group_by(VDS_ID, PLOT_CODE, SEASON, CROP) |>
  mutate(
    HR_PER_ACRE = sum(WORK_HR, na.rm = TRUE) / AREA_CROP
  ) |>
  distinct(VDS_ID, PLOT_CODE, SEASON, CROP, HR_PER_ACRE)
```


### Moyenne de Hr/acre pour les principales cultures

Pour calculer la moyenne de Hr/acre, il faut distinguer par champ avant d'additionner les ratios pour neutraliser les différences dans le nombre d'observations entre chaque champ. 

```{r Moyenne Hr/acre par culture}
# Calculer la moyenne de Hr/acre (variable MEAN_HACRE) par culture, toute main d'oeuvre confondue
mean_hacre_crop <- hr_per_acre |>
  group_by(CROP) |>
  summarise(
    MEAN_HACRE = mean(HR_PER_ACRE, na.rm = TRUE),
    n_plots = n(),
    .groups = "drop"
  )
```

Je ne prends en compte pour le graphique suivant que les champs avec une seule culture (MULTI_CROPING = FALSE) et seulement le travail humain (exclut les heures de travail relatives aux bullocks). 

```{r Graph- Sans multi-cropping et seulement le travail humain}
mean_hacre_crop |>
  ggplot(aes(x = reorder(CROP, MEAN_HACRE), y = MEAN_HACRE)) +
  geom_col(fill = "slateblue3", width = 0.7) +
  coord_flip() +
  labs(
    title = "Top 25: Moyenne d'heures de travail par acre",
    x = "",
    y = ""
  ) +
  scale_y_continuous(labels = comma) +
  theme_minimal()
```

```{r Graph- Top 10}
bar_mean_hacre <- mean_hacre_crop |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  arrange(desc(n_plots)) |>
  slice_head(n = 10) |>
  ggplot(aes(x = reorder(CROP, MEAN_HACRE), y = MEAN_HACRE)) +
  geom_col(fill = "darkolivegreen3", color = "darkolivegreen", width = 0.8, alpha = 0.8) +
  coord_flip() +
  labs(
    title = "    Labor time per acre, by crop and season",
    x = "",
    y = "Average work hours per acre per season"
  ) +
  scale_y_continuous(labels = comma) +
  theme_minimal() + 
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12, color = "grey20")
  )

bar_mean_hacre
```

```{r}
# Enregistrement automatique dans un fichier PNG
ggsave("figures/Labor_time_bar.png", plot = bar_mean_hacre, width = 8, height = 6, dpi = 300)
```


```{r, warning=FALSE, message=FALSE}
# Tableau des moyennes de Hr/acre pour les 15 principales cultures (sans multi-cropping)
mean_hacre_crop |>
  arrange(desc(n_plots)) |>
  slice_head(n = 15) |>
  select(CROP, MEAN_HACRE, n_plots) |>
  kable(
    digits = 1,
    col.names = c("Culture", "Hr/acre (moy.)", "Nb champs"),
    caption = "Top 15 cultures- Moyenne de Hr/acre sans multi-cropping"
  )
```


### Verif: Distribution de Hr/acre par culture

Les paragraphes suivants sont des vérifications par rapport à cette valeur.

D'abord, on vérifie le nombre de champs différents pour chaque culture, avec la base main_crops. Dans le top 25, la culture la moins répandue est CLUSTER BEAN avec 10 champs différents. 

Puis, on regarde la distribution des Hr/acre pour chaque culture. Tous les graphiques suivants (même pour les autres parties) ne considèrent que le travail humain et incluent les opérations non complétées (WORK_HR = 0). 

```{r, message=FALSE, warning=FALSE}
# Histogramme de Hr/acre pour PADDY
hr_per_acre |>
  filter(CROP == "PADDY") |>
  ggplot(aes(x = HR_PER_ACRE)) +
  geom_histogram(fill = "burlywood3", color = "white", bins = 30) +
  xlim(0, 1000) +
  theme_minimal() +
  labs(
    x = "Hr/acre par champ",
    y = "Nombre de champs",
    title = "Paddy: Distribution de Hr/acre"
  )
```

Pour paddy, il y a 15 champs (sur 1 325) qui ont un Hr/acre égal à 0. 


```{r, message=FALSE, warning=FALSE}
# Garder que les 10 première cultures
top_10_crops <- Cultivation_expand |>
  filter(CROP != "SEASONAL FALLOW") |>
  distinct(VDS_ID, PLOT_CODE, SEASON, CROP, AREA_CROP) |> 
  count(CROP, name = "nb_occurrences") |>
  arrange(desc(nb_occurrences)) |>
  slice_head(n = 10)
```

```{r, message=FALSE, warning=FALSE}
# Boxplot pour chaque culture de Hr/acre (seulement travail humain)
boxplot_hr_per_acre <- hr_per_acre |>
  inner_join(top_10_crops, by = "CROP") |>
  left_join(mean_hacre_crop |> select(CROP, MEAN_HACRE),
            by = "CROP") |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  ggplot(aes(y = reorder(CROP, MEAN_HACRE), x = HR_PER_ACRE)) +
  geom_boxplot(fill = "darkolivegreen3", alpha = 0.8) +
  xlim(0, 700) +
  theme_minimal() +
  labs(
    x = "Work hours per acre per season",
    y = "",
    title = "   Distribution of labor time per acre, by crop and season"
  ) +
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12, color = "grey20")
  )

boxplot_hr_per_acre
```

```{r}
ggsave("figures/Labor_time_boxplot.png", plot = boxplot_hr_per_acre, width = 8, height = 6, dpi = 300)
```


*********************************************************************************

## Décomposition du travail par opération

### Moyenne de Hr/acre par opération

Je calcule la moyenne de Hr/acre en différenciant par opération. Pour cela, je fais le ratio Hr/acre pour chaque opération par champ distinct. Puis comme précédemment, je calcule la moyenne de Hr/acre en divisant la somme des ratios par le nombre de champs distincts. 

Normalement, en additonnant tous les Hr/acre moyens par opération, on retombe sur la moyenne de Hr/acre calculée au début. 

```{r}
# Calculer le ratio Hr/acre par opération et par champ (variable HR_PER_OPER)
hr_per_oper <- Cultivation_expand |>
  group_by(VDS_ID, PLOT_CODE, SEASON, CROP, OPERATION) |> 
  # grouper par champ et opération
  mutate(
      HR_PER_OPER = sum(WORK_HR, na.rm = TRUE) / AREA_CROP
  ) |>
  distinct(VDS_ID, PLOT_CODE, SEASON, CROP, HR_PER_OPER, OPERATION)
```

```{r Moyenne Hr/acre par opération, message=FALSE, warning=FALSE}
# Calculer la moyenne de Hr/acre par opération et par culture
mean_hacre_oper <- hr_per_oper |>
  group_by(OPERATION, CROP) |>
  summarise(MEAN_HACRE = mean(HR_PER_OPER, na.rm = TRUE),
    n_plots = n(),
    .groups = "drop"
  )  |>
  mutate(MEAN_HACRE = round(MEAN_HACRE, 3))
```


#### Par cultures - Hr/acre moyen par opération

Les graphiques suivants se basent sur la productivité par acre (HR_PER_ACRE) et montre la moyenne de Hr/acre par opération. 

Je considère seulement les champs qui ont une seule culture et le travail humain. 

Pour Paddy : 

```{r}
mean_hacre_oper |>
  filter(CROP == "PADDY") |>
  filter(MEAN_HACRE > 0.5) |>
  ggplot(aes(x = reorder(OPERATION, MEAN_HACRE), y = MEAN_HACRE)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, fill = "orchid3") +
  geom_text(aes(label = round(MEAN_HACRE, 0)), 
            hjust = -0.2, 
            size = 3.5) +
  coord_flip() +
  labs(
    title = "Paddy: Hr/acre moyen par opération",
    x = "",
    y = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 10)
  )
```

Pour les 3 principales cultures : 

```{r}
mean_hacre_oper |>
  filter(CROP %in% c("PADDY", "WHEAT", "MAIZE")) |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  filter(MEAN_HACRE > 1) |>
  ggplot(aes(x = reorder(OPERATION, MEAN_HACRE), y = MEAN_HACRE, fill = CROP)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  facet_wrap(~ CROP, scales = "free_x") +
  geom_text(aes(label = round(MEAN_HACRE, 0)), 
            hjust = -0.2, 
            size = 3) +
  coord_flip(clip = "off") +
  labs(
    title = "Labor time per acre, by operation",
    x = "",
    y = "Hours worked per acre"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12, color = "gray20"),
    legend.position = "none",  
    plot.margin = margin(5, 20, 5, 5)
  )
```
```{r, message = False}
# Créer sa propre palette de couleurs
couleurs2 <- rainbow(12)[9:11]
```

```{r}
plot_3_crops_oper <- mean_hacre_oper |>
  filter(CROP %in% c("PADDY", "WHEAT", "MAIZE")) |>
  filter(!OPERATION %in% c("SUPERVISION", "NURSERY RAISING", "MARKETING", "OTHERS", "PLANT PROTECTION MEASURES")) |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  mutate(OPERATION = recode(OPERATION, `CHEMICAL FERTILIZER APPL.` = "FERTILIZER APPL.")) |>
  ggplot(aes(x = OPERATION, y = MEAN_HACRE, fill = CROP)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.6) +
  labs(
    title = "Average working hours per acre, by operation",
    x = "",
    y = "",
    fill = "Main crops"
  ) +
  scale_fill_manual(values = c(
    "RICE" = "yellowgreen",
    "WHEAT" = "darkgoldenrod2",
    "MAIZE" = "indianred1"
  )) +
  theme_minimal() +
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12)
  )

plot_3_crops_oper
```
```{r}
ggsave("figures/Labor_3_crops_operations.png", plot = plot_3_crops_oper, width = 8, height = 6, dpi = 300)
```


#### Toutes cultures - Hr/acre moyen par opération

Je calcule la moyenne des ratios Hr/acre toute cultures confondues. 

```{r}
all_mean_hacre_oper <- hr_per_oper |>
  group_by(OPERATION) |>
  summarise(
    MEAN_HACRE = mean(HR_PER_OPER, na.rm = TRUE),
    n_plots = n(),
    .groups = "drop"
  )
```

```{r Moyenne de Hr/acre (toutes cultures confondues)}
plot_all_mean <- all_mean_hacre_oper |>
  filter(MEAN_HACRE > 1) |>
  ggplot(aes(x = reorder(OPERATION, MEAN_HACRE), y = MEAN_HACRE)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.8, fill = "darkolivegreen3") +
  geom_text(aes(label = round(MEAN_HACRE, 0)), 
            hjust = -0.2, 
            size = 4) +
  coord_flip() +
  labs(
    title = "  Average working hours per acre, by operation",
    x = "",
    y = "Average working hours per acre per season"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text = element_text(size = 11.5),
    axis.title.x = element_text(size = 12, color = "gray20")
  )

plot_all_mean
```
```{r}
ggsave("figures/Labor_time_all_operations.png", plot = plot_all_mean, width = 8, height = 6, dpi = 300)
```


##### Comparaison entre cultures de Hr/acre moyen par opération

Les graphiques suivants comparent la moyenne de Hr/acre par culture pour les principales opérations. 

```{r Harvesting & Threshing}
mean_hacre_oper |>
  filter(OPERATION == "HARVESTING & THRESHING") |>
  filter(CROP %in% c("PADDY", "WHEAT", "MAIZE", "COTTON", "SOYBEAN", "SORGHUM", "CHICKPEA", "BLACK GRAM", "GROUNDNUT", "ONION")) |>
  ggplot(aes(x = reorder(CROP, n_plots), y = MEAN_HACRE)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, fill = "hotpink2") +
  geom_text(aes(label = round(MEAN_HACRE, 0)), 
            hjust = -0.2, 
            size = 3.5) +
  coord_flip() +
  labs(
    title = "Hr/acre moyen pour Harvesting/Threshing par culture",
    x = "",
    y = "Heures de travail par acre"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 10)
  )
```

```{r Hand Weeding}
mean_hacre_oper |>
  filter(OPERATION == "HAND WEEDING") |>
  filter(CROP %in% c("PADDY", "WHEAT", "MAIZE", "COTTON", "SOYBEAN", "SORGHUM", "CHICKPEA", "BLACK GRAM", "GROUNDNUT", "ONION")) |>
  ggplot(aes(x = reorder(CROP, n_plots), y = MEAN_HACRE)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, fill = "hotpink3") +
  geom_text(aes(label = round(MEAN_HACRE, 0)), 
            hjust = -0.2, 
            size = 3.5) +
  coord_flip() +
  labs(
    title = "Hr/acre moyen pour Hand Weeding par culture",
    x = "",
    y = "Heures de travail par acre"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 10)
  )
```

```{r Land preparation}
mean_hacre_oper |>
  filter(OPERATION == "LAND PREPARATION") |>
  filter(CROP %in% c("PADDY", "WHEAT", "MAIZE", "COTTON", "SOYBEAN", "SORGHUM", "CHICKPEA", "BLACK GRAM", "GROUNDNUT", "ONION")) |>
  ggplot(aes(x = reorder(CROP, n_plots), y = MEAN_HACRE)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, fill = "hotpink4") +
  geom_text(aes(label = round(MEAN_HACRE, 0)), 
            hjust = -0.2, 
            size = 3.5) +
  coord_flip() +
  labs(
    title = "Hr/acre moyen pour Land Preparation par culture",
    x = "",
    y = "Heures de travail par acre"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 10)
  )
```


#### Verif: Egalité des moyennes

Je me concentre sur Paddy pour comparer la moyenne de Hr/acre (toutes opérations confondues) et Hr/acre moyen par opération. Le but est de vérifier que : 

Moyenne de Hr/acre (toutes opérations) = somme de Hr/acre moyen par opération

Pour vérifier cela, j'additionne les moyennes de Hr/acre par opération pour le riz.

```{r}
paddy_mean_hacre_oper <- mean_hacre_oper |>
  filter(CROP == "PADDY") |>
  summarise(TOTAL_MEAN = sum(MEAN_HACRE, na.rm = TRUE)) |>
  mutate(TOTAL_MEAN = round(TOTAL_MEAN, 0)) |> 
  pull(TOTAL_MEAN)

mean_paddy <- mean_hacre_crop |> 
  filter(CROP == "PADDY") |>
  summarise(MEAN_HACRE = round(MEAN_HACRE, 0)) |> 
  pull(MEAN_HACRE)
```

```{r} 
cat("Moyenne du Hr/ratio (toutes opérations confondues):", mean_paddy, "\n")
cat("Somme des moyennes de Hr/ratio par opération:", paddy_mean_hacre_oper, "\n")
```

### Répartition du temps de travail par opération (en %)

On veut savoir comment se décompose le travail en fonction des opérations pour les principales cultures. Pour cela, je calcule la répartition du temps de travail par opération (en %). 

Les graphiques suivants se basent donc sur le total d'heures de travail (WORK_HR) et non sur la productivité par acre (HR_PER_ACRE).

Je considère seulement les champs qui ont une seule culture et le travail humain. 

```{r, message=FALSE, warning=FALSE}
prct_oper <- Cultivation_top_25 |>
  group_by(CROP, OPERATION) |>
  summarise(HR_PER_OPER = sum(WORK_HR, na.rm = TRUE), .groups = "drop") |>
  group_by(CROP) |>
  mutate(HR_PER_CROP = sum(HR_PER_OPER, na.rm = TRUE)) |>
  ungroup() |>
  arrange(desc(HR_PER_CROP))

prct_oper <- prct_oper |>
  group_by(CROP, OPERATION) |>
  mutate(proportion = round(100 * HR_PER_OPER/HR_PER_CROP, 1)) |>
  arrange(CROP, desc(proportion))
```


#### Paddy

```{r}
prct_oper |>
  filter(CROP == "PADDY") |>
  filter(proportion != 0.0) |>
  ggplot(aes(x = reorder(OPERATION, proportion), y = proportion)) +
  geom_bar(stat = "identity", position = "dodge", fill = "sandybrown", width = 0.7) +
  geom_text(aes(label = paste0(proportion, "%")), 
          hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(
    title = "Paddy- Répartition du temps de travail par opération (en %)",
    x = "",
    y = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 5)
  )
```


#### Principales cultures

```{r}
plot_prct_labor_time <- prct_oper |>
  mutate(CROP = recode(CROP, `PADDY` = "RICE")) |>
  filter(CROP %in% c("RICE", "WHEAT", "MAIZE")) |>
  filter(proportion > 1) |>
  ggplot(aes(x = CROP, y = HR_PER_OPER, fill = reorder(OPERATION, proportion))) +
  geom_bar(stat = "identity", position = "fill", width = 0.6, color = "white", linewidth = 0.3) +
  geom_text(aes(label = paste0(round(proportion, 0), "%")),
            position = position_fill(vjust = 0.5),
            size = 3.5) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Distribution of working hours by operation (in %)",
    x = "",
    y = "",
    fill = "Operation"
  ) +
  theme_minimal() +
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11),
  )

plot_prct_labor_time
```
```{r}
ggsave("figures/prct_labor_time.png", plot = plot_prct_labor_time, width = 8, height = 6, dpi = 300)
```


```{r, message = False}
# Créer sa propre palette de couleurs
couleurs1 <- viridis(15, option = "C")[2:15]
```

```{r}
prct_oper |>
  filter(
    proportion > 1,
    CROP %in% c("PADDY", "WHEAT", "MAIZE", "COTTON", "SOYBEAN", "SORGHUM", "CHICKPEA", "BLACK GRAM", "GROUNDNUT", "ONION")) |>
  filter(proportion > 1) |>
  ggplot(aes(x = CROP, y = HR_PER_OPER, fill = reorder(OPERATION, proportion))) +
  geom_bar(stat = "identity", position = "fill", width = 0.8, color = "white", linewidth = 0.3) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Top 10: Répartition du temps de travail par opération (en %)",
    x = "",
    y = "",
    fill = ""
  ) +
  scale_fill_manual(values = couleurs1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    legend.text = element_text(size = 8)
  )
```


### Total d'heures par opération 

Cette fois-ci, je regarde comment se décompose le travail par opération, en prennant en compte le total d'heures par opération (en valeur absolue plutôt que pourcentage).

On compare pour les principales opérations le nombre d'heures de travail par saison et par culture. 

```{r}
# Calculer le nombre d'heures par opération et par saison en incluant SEASON pour différencier le travail par saison (Rabi ou Kharif)
total_hours <- Cultivation_top_25 |>
  group_by(CROP, OPERATION, SEASON) |>
  summarise(HR_PER_OPER = sum(WORK_HR, na.rm = TRUE), .groups = "drop") |>
  group_by(CROP, SEASON) |>
  mutate(HR_PER_CROP = sum(HR_PER_OPER, na.rm = TRUE)) |>
  ungroup() |>
  arrange(desc(HR_PER_CROP))
```

```{r Principales cultures: toutes opérations confondues}
total_hours |>
  filter(CROP %in% c("PADDY", "WHEAT", "MAIZE", "COTTON", "SOYBEAN", "SORGHUM", "CHICKPEA", "BLACK GRAM", "GROUNDNUT", "ONION")) |>
  ggplot(aes(x = reorder(CROP, HR_PER_CROP), y = HR_PER_CROP, fill = SEASON)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  coord_flip() +
  labs(
    title = "Heures de travail totales par culture et par saison",
    x = "",
    y = "",
    fill = "Saison"
  ) +
  scale_fill_manual(
    values = c("KHARIF" = "steelblue3", "RABI" = "springgreen2")
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 10)
  )
```


********************************************************************************
A refaire 
********************************************************************************

## Comprendre les différences dans Hr/acre moyen par culture

Je souhaite comprendre les différences en productivité par acre observées entre les cultures. 

Pour cela, je compare les cultures les moins productives et les plus productives par rapport à d'autres variables : répartition du temps de travail par opération (OPERATION), total de travail total (WORK_HR), taille moyenne des champs (PLOT_AREA).


### Comparer les cultures plus ou moins productives

Je regarde comment se décompose la répartition des opérations dans le temps de travail entre les cultures les plus productives (faible Hr/acre) et les moins productives (haut Hr/acre). 

Le but est de comprendre pourquoi de telles disparités existent selon les cultures. Est-ce que ces différences de productivité sont dûes à des opérations sur-représentées ?

```{r}
CROPS_ORDER <- c("CHILLIES", "PEAS", "POTATO", "SESAMUM", "PIGEONPEA",  "SOYBEAN")

prct_oper |>
  filter(proportion > 1) |>
  filter(CROP %in% CROPS_ORDER) |>
  ggplot(aes(x = factor(CROP, levels = CROPS_ORDER), y = HR_PER_OPER, fill = reorder(OPERATION, proportion))) +
  geom_bar(stat = "identity", position = "fill", width = 0.8, color = "white", linewidth = 0.3) +
  geom_vline(xintercept = 3.5, linetype = "dashed", color = "gray20") +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(limits = CROPS_ORDER) +
  labs(
    title = "Comparaison: Répartition du temps de travail par opération (en %)",
    x = "",
    y = "",
    fill = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    legend.text = element_text(size = 8) 
    ) +
  annotate("text", x = 2, y = 1.06, label = "Moins productives", hjust = 0.5, size = 3.5, fontface = "bold") +
  annotate("text", x = 5, y = 1.06, label = "Plus productives", hjust = 0.5, size = 3.5, fontface = "bold") 
```


Visiblement les différences de Hr/acre ne sont pas liées à des opérations particulièrement présentes dans les cultures les moins productives. Il ne semble pas avoir de lien entre la proportion de chaque opération et le Hr/acre moyen. 

```{r}
# Comparer la part de chaque opération pour les cultures les plus et les moins productives
prct_oper |>
  filter(CROP %in% CROPS_ORDER, proportion > 1) |>
  mutate(PRODUCTIVITY_GROUP = case_when(
    CROP %in% c("CHILLIES", "PEAS", "POTATO") ~ "Moins productives",
    CROP %in% c("SESAMUM", "PIGEONPEA", "SOYBEAN") ~ "Plus productives"
  )) |>
  group_by(PRODUCTIVITY_GROUP, OPERATION) |>
  summarise(mean_prop = mean(proportion, na.rm = TRUE), .groups = "drop") |>
  mutate(mean_prop = round(mean_prop, 0)) |>
  pivot_wider(names_from = PRODUCTIVITY_GROUP, values_from = mean_prop)
```


### Comparer la taille moyenne des parcelles par culture

On regarde si les différences de Hr/acre moyen observées entre les cultures sont à la taille des parcelles. Est-ce que les cultures les moins productives (moyenne de Hr/acre plus haute) sont celles avec les plus petites parcelles

par culture, notamment pour CHILLIES

```{r}
area_per_crop <- Cultivation_top_25 |>
  group_by(VDS_ID, PLOT_CODE, SEASON, CROP) |>
  slice(1) |>  # Une seule ligne par champ
  ungroup() |>
  group_by(CROP) |>
  summarise(mean_area = mean(AREA_CROP, na.rm = TRUE))

area_per_crop |>
  filter(CROP %in% c("CHILLIES", "CHRYSANTHEMUM", "CLUSTER BEAN", "PADDY", "SESAMUM", "LATHYRUS", "PIGEONPEA")) |>
  mutate(mean_area = round(mean_area, 2)) |>
  knitr::kable(
    caption = "Taille moyenne des parcelles pour les cultures les plus/moins productives",
    col.names = c("Culture", "Superficie moyenne (acres)")
  )
```

La taille de la parcelle ne semble pas expliquer les différence dans la moyenne de  Hr/acre, puisque CHILLIES (la culture de loin la moins productive) a une superficie moyenne proche de SESAMUM (l'une des plus productives). 


*********************************************************************************





