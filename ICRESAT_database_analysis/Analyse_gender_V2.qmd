---
title: "Fichier 3 (V2) : Analyse par genre de la base Cultivation 2014"
format:
  html:
    toc: true
    theme: cosmo
editor: source
params:
  annee: 2011  # par défaut
---

```{r cleaning, message=FALSE, warning=FALSE}
rm(list = setdiff(ls(), "params"))
graphics.off()
cat("\014")
```

```{r library, message=FALSE, warning=FALSE}
here::i_am("ICRESAT_database_analysis/Analyse_caste.qmd")
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(scales)
library(knitr)
library(tibble)
library(tidyverse)
library(gt)
```

```{r import_data}
Cultivation_expand_all <- readRDS(here::here("Base de données générées", "Cultivation_expand", "Cultivation_expand_all.rds"))

Cultivation_oper_all <- readRDS(here::here("Base de données générées", "Cultivation_oper", "Cultivation_oper_all.rds"))

Cultivation_plot_all <- readRDS(here::here("Base de données générées", "Cultivation_plot", "Cultivation_plot_all.rds"))

Cultivation_hh_all <- readRDS(here::here("Base de données générées", "Cultivation_hh", "Cultivation_hh_all.rds"))
```


********************************************************************************

# Modifier la base

Sélectionner les variables sur le travail (depuis Cultivation_expand  pour récupérer l'information par mois), puis pivoter la base en long. 

*Sélectionner les variables sur le travail*

```{r}
cols_labor <- c(
  paste0("WORK_HR_", c("HM", "FM", "FF", "HF", "HC", "OB", "RS", "EF", "HB", "EM", "FC", "EB", "T")),
  paste0("HACRE_", c("HM", "FM", "FF", "HF", "HC", "OB", "RS", "EF", "HB", "EM", "FC", "EB", "T"))
)

table_labor <- Cultivation_expand_all |>
  select(YEAR, VDS_ID, SEASON, CROP, PLOT_CODE, SUB_PLOT_CODE, CROP_AREA, MONTH, OPERATION, all_of(cols_labor))

# Additionner en fonction de l'opération et du mois
sum_cols_labor <- function(df, groups_vars, cols_to_sum) {
  df |>
    group_by(across(all_of(groups_vars))) |>
    summarise(across(all_of(cols_to_sum), ~ sum(.x, na.rm = TRUE)), .groups = "drop")
}

groups_vars <- c("YEAR", "VDS_ID", "SEASON", "CROP", "SUB_PLOT_CODE", "CROP_AREA", "MONTH", "OPERATION")

table_labor <- sum_cols_labor(table_labor, groups_vars, cols_labor)
```


*Pivoter la table en long*

```{r}
cols_hr <- paste0("WORK_HR_", c("HM", "FM", "FF", "HF", "HC", "OB", "RS", "EF", "HB", "EM", "FC", "EB"))
cols_hacre <- paste0("HACRE_", c("HM", "FM", "FF", "HF", "HC", "OB", "RS", "EF", "HB", "EM", "FC", "EB"))

# Pivoter les heures travaillées
table_hr <- table_labor |>
  select(all_of(groups_vars), all_of(cols_hr)) |>
  pivot_longer(
    cols = all_of(cols_hr),
    names_to = "type",
    names_prefix = "WORK_HR_",
    values_to = "Work_hours"
  )

# Pivoter les heures par acre
table_hacre <- table_labor |>
  select(all_of(groups_vars), all_of(cols_hacre)) |>
  pivot_longer(
    cols = all_of(cols_hacre),
    names_to = "type",
    names_prefix = "HACRE_",
    values_to = "Hours_per_acre"
  )

# Fusionner les deux tables
table_labor <- left_join(table_hr, table_hacre, by = c(all_of(groups_vars), "type"))
```


*Ajouter les variables Gender et Employment*

```{r}
table_labor <- table_labor |>
  mutate(
    Gender = case_when(
      type %in% c("FF", "HF", "EF") ~ "Female",
      type %in% c("FM", "HM", "EM") ~ "Male",
      TRUE ~ NA_character_
    ),
    Employment = case_when(
      type %in% c("HM", "HF") ~ "Hired",
      type %in% c("FM", "FF") ~ "Family",
      TRUE ~ NA_character_
    )
  )
```


********************************************************************************

# Travail par mois

On compare les heures travaillées par mois selon le genre. 

Je ne peux pas faire ce graphique sur le nombre de travailleurs ou les heures par travailleurs car la variable LAB_TYPE représente tout le travail effectué pour une opération, donc peut regrouper une ou plusieurs personnes. 

```{r}
month_levels <- c("janv", "feb", "march", "april", "may", "june",
                  "july", "aug", "sept", "oct", "nov", "dec")

hr_per_gender <- table_labor |>
  filter(!is.na(Gender), !is.na(MONTH)) |>
  group_by(Gender, MONTH) |>
  summarise(Work_hours = sum(Work_hours, na.rm = TRUE), .groups = "drop") |>
  mutate(MONTH = factor(MONTH, levels = month_levels, ordered = TRUE))
```

```{r}
plot_gender_hours_month <- hr_per_gender |>
  filter(!is.na(MONTH)) |>
  ggplot(aes(x = MONTH, y = Work_hours, fill = Gender)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.6) +
  labs(
    title = "Hours worked per month, by gender",
    x = "",
    y = "",
    fill = "Gender"
    ) +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12)
  )

plot_gender_hours_month
```

```{r}
ggsave("figures/Gender_labor_month.png", plot = plot_gender_hours_month, width = 8, height = 6, dpi = 300)
```



********************************************************************************

# Travail employé

On regarde le type de main d'oeuvre selon le genre : employé, famille et échange à partir de la variable Employment. 

Je regarde le nombre d'heures travaillées selon le type d'emploi et le genre. 

```{r}
hired_work_all <- table_labor |>
  filter(!is.na(Gender), !is.na(Employment)) |>
  group_by(Gender, Employment) |>
  summarise(Work_hours = sum(Work_hours, na.rm = TRUE), .groups = "drop") 
```


## Sur toute l'année

```{r}
labor_employment <- hired_work_all |>
  ggplot(aes(x = Gender, y = Work_hours, fill = Gender)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.8) +
  facet_wrap(~ Employment, scales = "free_x") +
  labs(
    title = "Hours worked on the farm by gender and employment type",
    x = "",
    y = ""
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 12),
    strip.text = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    panel.grid.major = element_line(color = "grey80"),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA)
  )

labor_employment
```

```{r}
ggsave("figures/Gender_labor_employment.png", plot = labor_employment, width = 8, height = 6, dpi = 300)
```

Les femmes travaillent bien plus en étant employées qu'en faisant partie du ménage et leurs heures travaillées employées dépassent celles des hommes employés. 


## Par mois 

*Travail employé*

Le but est de regarder si les hommes et femmes employés sont embauchés durant les mêmes périodes. 

```{r}
hired_work_month <- table_labor |>
  group_by(Gender, Employment, MONTH) |>
  summarise(Work_hours = sum(Work_hours, na.rm = TRUE), .groups = "drop") |>
  mutate(MONTH = factor(MONTH, levels = month_levels, ordered = TRUE)) |>
  filter(!is.na(MONTH))
```

```{r}
plot_hired_month <- hired_work_month |>
  filter(Employment == "Hired") |>
  ggplot(aes(x = MONTH, y = Work_hours, fill = Gender)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6) +
  labs(
    title = "Hired work: Hours worked by gender, by month",
    x = "",
    y = "",
    fill = "Gender"
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12)
  )

plot_hired_month
```
Les femmes et hommes sont embauchés lors des mêmes périodes, mais pas dans la même proportion. 


*Travail familial*

Pour le travail familail, est-ce que les hommes et femmes travaillent durant les mêmes périodes ?

```{r}
plot_family_month <- hired_work_month |>
  filter(Employment == "Family") |>
  ggplot(aes(x = MONTH, y = Work_hours, fill = Gender)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6) +
  labs(
    title = "Family work: Hours worked by gender, by month",
    x = "",
    y = "",
    fill = "Gender"
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
    theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12)
  )

plot_family_month
```

Le travail des femmes au sein du ménage semble plus constant dans l'année que celui des hommes, qui ont un pic de travail en juillet (moisson de Kharif)

Quelles sont les opérations faites en juillet, qui demandent un temps de travail important et sont réalisées par les hommes de la famille ?

```{r}
oper_per_month <- table_labor |>
  filter(Employment == "Family", Gender == "Male") |>
  group_by(MONTH, OPERATION) |>
  summarise(Oper_hours = sum(Work_hours, na.rm = TRUE), .groups = "drop") |>
  group_by(MONTH) |>
  mutate(
    Total_hours = sum(Oper_hours, na.rm = TRUE),
    prct_oper = round(100 * Oper_hours / Total_hours, 2),
    MONTH = factor(MONTH, levels = month_levels, ordered = TRUE)
  ) |>
  ungroup()
```

```{r}
oper_per_month |>
  filter(MONTH == "july", !is.na(MONTH)) |>
  arrange(MONTH, desc(prct_oper)) |>
  select(MONTH, OPERATION, prct_oper) |>
  kable(
    caption = "Pourcentage de chaque opération dans le temps de travail des hommes de la famille en juillet",
    col.names = c("Mois", "Opération", "Part (%)")
  )
```


********************************************************************************

# Travail par opération

## Toutes cultures: total d'heures travaillées et moyenne de Hr/acre

On regarde sur quelles opérations les femmes travaillent le plus. 

```{r}
oper_per_gender <- table_labor |>
  filter(!is.na(Gender)) |>
  group_by(Gender, OPERATION) |>
  summarise(Work_hours = sum(Work_hours, na.rm = TRUE), .groups = "drop") 
```

```{r}
Gender_labor_operation <- oper_per_gender |>
  filter(OPERATION != "OTHERS" & OPERATION != "NURSERY RAISING" & OPERATION != "MARKETING") |>
  mutate(OPERATION = recode(OPERATION, `PLANT PROTECTION MEASURES` = "PLANT PROTECTION")) |>
  ggplot(aes(x = OPERATION, y = Work_hours, fill = GENDER)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6) +
  labs(
    title = "Hours worked per operation, by gender",
    x = "",
    y = "",
    fill = "Gender"
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12)
  )

Gender_labor_operation
```

```{r}
ggsave("figures/Gender_labor_operation.png", plot = Gender_labor_operation, width = 8, height = 6, dpi = 300)
```

Les femmes travaillent le plus lors du Hand weeding et du Harvesting/Threshing, et dans une proportion bien plus importante que les hommes. 

Je regarde la moyenne de Hr/acre par opération en fonction du genre. 



