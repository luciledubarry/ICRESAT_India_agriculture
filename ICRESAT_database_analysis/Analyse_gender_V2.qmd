---
title: "Fichier 3 (V2) : Analyse par genre de la base Cultivation 2014"
format:
  html:
    toc: true
    theme: cosmo
editor: source
params:
  annee: 2011  # par défaut
---

```{r cleaning, message=FALSE, warning=FALSE}
rm(list = setdiff(ls(), "params"))
graphics.off()
cat("\014")
```

```{r library, message=FALSE, warning=FALSE}
here::i_am("ICRESAT_database_analysis/Analyse_caste.qmd")
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(scales)
library(knitr)
library(tibble)
library(tidyverse)
library(gt)
```

```{r import_data}
Cultivation_expand_all <- readRDS(here::here("Base de données générées", "Cultivation_expand", "Cultivation_expand_all.rds"))

Cultivation_oper_all <- readRDS(here::here("Base de données générées", "Cultivation_oper", "Cultivation_oper_all.rds"))

Cultivation_plot_all <- readRDS(here::here("Base de données générées", "Cultivation_plot", "Cultivation_plot_all.rds"))

Cultivation_hh_all <- readRDS(here::here("Base de données générées", "Cultivation_hh", "Cultivation_hh_all.rds"))
```


********************************************************************************

# Modifier la base

Sélectionner les variables sur le travail (depuis Cultivation_expand  pour récupérer l'information par mois), puis pivoter la base en long. 

*Travail féminin et masculin*

```{r}
fem_cols <- c("WORK_HR_HF", "WORK_HR_FF", "WORK_HR_EF")
masc_cols <- c(paste0("WORK_HR_", c("HM", "FM", "OB", "HB", "EM", "EB")))
hired_work <- c("WORK_HR_HF", "WORK_HR_HM")

# Additionner les heures par ligne en fonction du genre
Cultivation_expand_all <- Cultivation_expand_all |>
  mutate(
    fem_work = rowSums(select(Cultivation_expand_all, all_of(fem_cols)), na.rm = TRUE),
    masc_work = rowSums(select(Cultivation_expand_all, all_of(masc_cols)), na.rm = TRUE),
    hired_work = rowSums(select(Cultivation_expand_all, all_of(hired_cols)), na.rm = TRUE),
    fem_work_hacre = fem_work/CROP_AREA,
    masc_work_hacre = masc_work/CROP_AREA,
    hired_work_hacre = hired_work/CROP_AREA
  )
```


*Sélectionner les variables sur le travail*

```{r}
table_labor <- Cultivation_expand_all |>
  select(YEAR, VDS_ID, SEASON, CROP, PLOT_CODE, SUB_PLOT_CODE, CROP_AREA, MONTH, OPERATION, contains(c("WORK_HR", "HACRE")), fem_work, masc_work, fem_work_hacre, masc_work_hacre)

# Additionner en fonction de l'opération et du mois
sum_cols_labor <- function(df, groups_vars, cols_to_sum) {
  df |>
    group_by(across(all_of(groups_vars))) |>
    summarise(across(all_of(cols_to_sum), ~ sum(.x, na.rm = TRUE)), .groups = "drop")
}

groups_vars <- c("YEAR", "VDS_ID", "SEASON", "CROP", "SUB_PLOT_CODE", "CROP_AREA", "MONTH", "OPERATION")

cols_labor <- c(
  paste0("WORK_HR_", c("HM", "FM", "FF", "HF", "HC", "OB", "RS", "EF", "HB", "EM", "FC", "EB", "T")),
  paste0("HACRE_", c("HM", "FM", "FF", "HF", "HC", "OB", "RS", "EF", "HB", "EM", "FC", "EB", "T")),
  "fem_work", "masc_work", "fem_work_hacre", "masc_work_hacre"
)

table_labor <- sum_cols_labor(table_labor, groups_vars, cols_labor)
```


*Pivoter la table en long*

```{r}
table_labor <- table_labor |>
  pivot_longer(
    cols = all_of(cols_labor),
    names_to = "Lab_type",
    values_to = "Work_hours"
  )
```


********************************************************************************

# Travail par mois

On compare les heures travaillées par mois selon le genre. 

Je ne peux pas faire ce graphique sur le nombre de travailleurs ou les heures par travailleurs car la variable LAB_TYPE représente tout le travail effectué pour une opération, donc peut regrouper une ou plusieurs personnes. 

```{r}
month_levels <- c("janv", "feb", "march", "april", "may", "june",
                  "july", "aug", "sept", "oct", "nov", "dec")

hr_per_gender <- Cultivation_expand_all |>
  group_by(MONTH, .keep_all = TRUE) |>
  summarise(fem_work = sum(fem_work, na.rm = TRUE),
            masc_work = sum(masc_work, na.rm = TRUE),
            .groups = "drop") |>
  pivot_longer(
    cols = c(fem_work, masc_work),
    names_to = "Gender",
    values_to = "Work_hours"
  ) |>
  mutate(MONTH = factor(MONTH, levels = month_levels, ordered = TRUE))
```

```{r}
plot_gender_hours_month <- hr_per_gender |>
  ggplot(aes(x = MONTH, y = Work_hours, fill = Gender)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), witdh = 0.6) +
  labs(
    title = "Hours worked per month, by gender",
    x = "",
    y = "",
    fill = "Gender"
    ) +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    axis.text.y = element_text(ize = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12)
  )

plot_gender_hours_month
```

```{r}
ggsave("figures/Gender_labor_month.png", plot = plot_gender_hours_month, widtch = 8, height = 6, dpi = 300)
```



********************************************************************************

# Travail employé

On regarde le type de main d'oeuvre selon le genre : employé, famille et échange à partir de la variable Employment. 

Je regarde le nombre d'heures travaillées selon le type d'emploi et le genre. 

```{r}
hired_work_all <- Cultivation_expand_all |>
  group_by(GENDER, EMPLOYMENT) |>
  summarise(TOTAL_HR = sum(WORK_HR, na.rm = TRUE), .groups = "drop")
```




